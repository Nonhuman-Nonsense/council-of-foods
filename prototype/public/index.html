<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Council Prototype</title>
  <link rel="stylesheet" href="style.css?v=2.0">
  <link href="favicon.png" rel="shortcut icon" type="image/png" />
  <script src="/socket.io/socket.io.js"></script>
  <script src="vue.global.js"></script>
  <style>
    [v-cloak] {
      display: none;
    }
  </style>
</head>

<body>
  <div id="app" class="app-layout" v-cloak>

    <!-- LEFT SIDEBAR: Explorer -->
    <aside class="sidebar sidebar-left" :class="{ collapsed: !localOptions.leftSidebarOpen }">
      <div class="sidebar-header">
        <h3>Explorer</h3>
        <button class="icon-btn" @click="toggleSidebar('left')">
          <span v-if="localOptions.leftSidebarOpen">«</span><span v-else>»</span>
        </button>
      </div>
      <div class="sidebar-content">
        <!-- Language -->
        <div class="section-group">
          <label>Language</label>
          <select v-model="options.language">
            <option v-for="lang in available_languages" :key="lang" :value="lang">{{ lang }}</option>
          </select>
        </div>
        <hr>
        <!-- Rooms -->
        <div class="section-group">
          <label>Rooms</label>
          <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <button @click="addRoom" style="flex: 1;">+</button>
            <button @click="removeRoom" style="width: 40px;">-</button>
          </div>
          <div class="room-list" style="display: flex; flex-direction: column; gap: 4px;">
            <button v-for="(room, index) in currentLanguageData.rooms" :key="index" @click="currentRoomIndex = index"
              :class="{ primary: currentRoomIndex === index }"
              style="text-align: left; overflow: hidden; text-overflow: ellipsis;">
              {{ room.name || 'Untitled Room' }}
            </button>
          </div>
        </div>
        <hr>
        <div class="section-group" style="margin-top: auto;">
          <button @click="factoryReset" style="width: 100%;">Factory Reset</button>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <div id="split-view-container" class="split-view">

        <!-- LEFT PANE: Editor -->
        <div class="split-pane pane-editor" :style="{ width: editorWidthPercent + '%' }" v-if="currentRoom">
          <div class="sidebar-header">
            <h3>Editor</h3>
          </div>
          <div style="flex: 1; overflow-y: auto; padding: 15px;">

            <!-- Room Meta -->
            <label>Room Name</label>
            <input v-model="currentRoom.name" type="text" placeholder="Room name">

            <label>Topic / Panel Prompt</label>
            <textarea v-model="currentRoom.topic" placeholder="Describe the topic..." rows="3"></textarea>

            <label>System Prompt (Shared)</label>
            <textarea v-model="currentSystemPrompt" placeholder="System prompt..." rows="3"></textarea>
            <small style="color: var(--text-secondary); display: block; margin-bottom: 15px;">[TOPIC] will be replaced
              by the room topic.</small>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 15px 0;">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h3>Characters</h3>
              <div>
                <button class="icon-btn" @click="addCharacter">+</button>
                <button class="icon-btn" @click="removeCharacter">-</button>
              </div>
            </div>

            <!-- Character List (Sortable) -->
            <div id="characters">
              <div class="character-card" v-for="(character, index) in currentRoom.characters"
                :key="character._ui_id || index">
                <!-- Card Header -->
                <div class="card-header" @click="toggleCharacterExpanded(character._ui_id)">
                  <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                    <span class="drag-handle" @click.stop>☰</span>
                    <!-- Name Input (Clicking it should not toggle accordion) -->
                    <input type="text" class="input-minimal" placeholder="Name" v-model="character.name" @click.stop>
                  </div>
                  <div style="display: flex; align-items: center; gap: 5px;">
                    <!-- Toggle Icon -->
                    <button class="icon-btn" style="font-size: 12px;">
                      {{ localOptions.expandedCharacters[character._ui_id] ? '▼' : '▶' }}
                    </button>
                    <!-- Delete Button -->
                    <button class="icon-btn" @click.stop="removeCharacter(index)" title="Remove"
                      style="color: var(--danger-color);">×</button>
                  </div>
                </div>

                <!-- Card Body (Collapsible) -->
                <div class="card-body" v-if="localOptions.expandedCharacters[character._ui_id]">
                  <label class="sub-label">System Prompt</label>
                  <textarea class="input-area" placeholder="Character prompt..." v-model="character.prompt"
                    v-auto-resize></textarea>

                  <label class="sub-label">Voice Options</label>
                  <div class="voice-selector">
                    <template v-for="voiceName in audioVoices" :key="voiceName">
                      <label class="voice-chip" :class="{ active: character.voice === voiceName }">
                        <input type="radio" :value="voiceName" v-model="character.voice" style="display: none;">
                        {{ voiceName }}
                      </label>
                    </template>
                  </div>

                  <input type="text" placeholder="Voice Instruction (e.g. 'Excited')"
                    v-model="character.voiceInstruction" style="margin-top: 5px;">
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- RESIZER -->
        <div class="resizer" @mousedown="startResize"></div>

        <!-- RIGHT PANE: Output -->
        <div class="split-pane pane-output" :style="{ width: (100 - editorWidthPercent) + '%' }">
          <div class="sidebar-header" style="justify-content: flex-start; gap: 10px;">
            <h3>Conversation</h3>
            <div style="margin-left: auto; display: flex; gap: 5px;">
              <!-- Conversation Controls -->
              <button v-if="!conversationActive && !endMessage" class="primary" @click="toggleConversation">
                {{ conversationStarted ? 'Resume' : 'Start' }}
              </button>
              <button v-if="conversationActive" @click="toggleConversation">Pause</button>
              <button v-if="conversationStarted && !conversationActive" @click="restartConversation">Restart</button>
              <button v-if="endMessage" class="primary" @click="continueConversation">Keep Going</button>

              <div style="border-left: 1px solid var(--border-color); margin: 0 5px;"></div>

              <!-- Audio Controls -->
              <button class="icon-btn" @click="audioBack">⏮</button>
              <button class="icon-btn" @click="audioToggle"
                :style="{ color: audioPaused ? 'var(--danger-color)' : '' }">
                {{ audioIsPlaying && !audioPaused ? '⏸' : '▶' }}
              </button>
              <button class="icon-btn" @click="audioNext">⏭</button>
            </div>
          </div>

          <!-- Chat Output -->
          <div id="conversation-container" style="flex: 1; padding: 20px; overflow-y: auto;">
            <div v-if="conversation.length === 0 && !loading"
              style="text-align: center; color: var(--text-secondary); margin-top: 50px;">
              Ready to start.
            </div>

            <div v-for="turn in conversation" :key="turn.id" :id="turn.id" class="chat-bubble" :class="{ 
                        'user': false, /* Helper to distinguish styles if needed, user logic is implied by name context usually */ 
                        'chair': turn.speaker === 'Chair', 
                        'character': turn.speaker !== 'Chair' 
                      }" style="margin-bottom: 10px;" v-show="localOptions.showTrimmed || turn.type !== 'skipped'">
              <div class="bubble-header">{{ turn.speaker }}</div>

              <div v-if="localOptions.showTrimmed && turn.pretrimmed" class="trimmed"
                style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 5px;"
                v-html="turn.pretrimmed.split('\n').join('<br>')"></div>

              <div v-html="turn.text.split('\n').join('<br>')"></div>

              <div v-if="localOptions.showTrimmed && turn.trimmed" class="trimmed"
                style="color: var(--text-secondary); font-size: 0.9em; margin-top: 5px;"
                v-html="turn.trimmed.split('\n').join('<br>')"></div>
            </div>

            <div v-if="loading" class="loader" style="text-align: center; padding: 20px;">Thinking...</div>
            <div v-if="endMessage"
              style="text-align: center; padding: 20px; font-weight: bold; color: var(--success-color);">{{ endMessage
              }}</div>
          </div>

          <!-- Injection Bar -->
          <div style="padding: 10px; border-top: 1px solid var(--border-color); background: var(--bg-panel);">
            <div style="display: flex; gap: 5px;">
              <textarea v-model="options.injectPrompt"
                placeholder="Inject instruction (e.g. 'Ask specifically about apples')..." rows="1"
                style="flex: 1; margin: 0;"></textarea>
              <button @click="submitInjection" :disabled="!!injectionStatus" class="primary">Send</button>
            </div>
            <div
              style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 11px; color: var(--text-secondary);">
              <span>{{ injectionStatus || 'Injection helper' }}</span>
              <button class="icon-btn" @click="removeLastMessage" title="Remove last message">↩ Undo Last</button>
            </div>
          </div>
        </div>

      </div>
    </main>

    <!-- RIGHT SIDEBAR: Options -->
    <aside class="sidebar sidebar-right" :class="{ collapsed: !localOptions.rightSidebarOpen }">
      <div class="sidebar-header">
        <button class="icon-btn" @click="toggleSidebar('right')">
          <span v-if="localOptions.rightSidebarOpen">»</span><span v-else>«</span>
        </button>
        <h3>Settings</h3>
      </div>
      <div class="sidebar-content">
        <div class="section-group">
          <label>Model</label>
          <input type="text" v-model="options.gptModel">
          <small style="color: var(--text-secondary);">See OpenAI docs for models</small>
        </div>
        <hr>
        <div class="section-group">
          <label>Temperature: {{ options.temperature }}</label>
          <input type="range" min="0" max="2.0" step="0.01" v-model.number="options.temperature">
        </div>
        <div class="section-group">
          <label>Max Tokens: {{ options.maxTokens }}</label>
          <input type="range" min="1" max="600" step="10" v-model.number="options.maxTokens">
        </div>
        <div class="section-group">
          <label>Freq Penalty: {{ options.frequencyPenalty }}</label>
          <input type="range" min="0" max="2.0" step="0.01" v-model.number="options.frequencyPenalty">
        </div>
        <div class="section-group">
          <label>Pres Penalty: {{ options.presencePenalty }}</label>
          <input type="range" min="0" max="2.0" step="0.01" v-model.number="options.presencePenalty">
        </div>
        <hr>
        <div class="section-group">
          <label>Audio Speed: {{ options.audio_speed }}</label>
          <input type="range" min="0.5" max="2.0" step="0.05" v-model.number="options.audio_speed">
        </div>
        <div class="section-group">
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" v-model="options.skipAudio" style="width: auto; margin: 0;"> Skip Generating Audio
          </label>
        </div>
        <hr>
        <h3>Server Trimming</h3>
        <div style="display: flex; flex-direction: column; gap: 5px;">
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" v-model="options.trimSentance" style="width: auto; margin: 0;"> Sentence
          </label>
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" v-model="options.trimParagraph" style="width: auto; margin: 0;"> Paragraph
          </label>
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" v-model="options.trimChairSemicolon" style="width: auto; margin: 0;"> Chair Semicolon
          </label>
        </div>
        <hr>
        <label style="display: flex; align-items: center; gap: 5px;">
          <input type="checkbox" v-model="localOptions.showTrimmed" style="width: auto; margin: 0;"> Show Trimmed
          Content
        </label>
      </div>

      <!-- Theme Switcher (Bottom) -->
      <div
        style="padding: 10px; border-top: 1px solid var(--border-color); display: flex; justify-content: center; gap: 8px; background: var(--bg-panel);">
        <button class="icon-btn" @click="setTheme('')" title="Blue"
          style="width: 12px; height: 12px; background: #1a73e8; border-radius: 50%; padding:0;"></button>
        <button class="icon-btn" @click="setTheme('tomato')" title="Tomato"
          style="width: 12px; height: 12px; background: #e04f38; border-radius: 50%; padding:0;"></button>
        <button class="icon-btn" @click="setTheme('lime')" title="Lime"
          style="width: 12px; height: 12px; background: #558b2f; border-radius: 50%; padding:0;"></button>
        <button class="icon-btn" @click="setTheme('grape')" title="Grape"
          style="width: 12px; height: 12px; background: #9d46ff; border-radius: 50%; padding:0;"></button>
        <button class="icon-btn" @click="setTheme('berry')" title="Berry"
          style="width: 12px; height: 12px; background: #e91e63; border-radius: 50%; padding:0;"></button>
      </div>
    </aside>

  </div>

  <script src="Sortable.min.js"></script>
  <script src="prototype_client.js?v=2.1"></script>
</body>

</html>